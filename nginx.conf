# Nginx configuration for production Next.js app

events {
    worker_connections 1024;
}

http {
    upstream nextjs {
        server app:3000;  # This points to the Next.js container
    }

    server {
        listen 82;  # Exposed port for Nginx (can be changed to 80 or any other port)
        server_name eve-helper.com;  # Replace with your domain

        # Handle requests to static files (like images, JavaScript, etc.)
        location /_next/ {
            root /app;  # Points to where Next.js static files are located
            try_files $uri $uri/ =404;
        }

        location /static/ {
            root /app;  # Points to where Next.js static files are located
            try_files $uri $uri/ =404;
        }

        # Handle requests to root and other dynamic content (Next.js app)
        location / {
            try_files $uri @nextjs;
        }

        # Fallback to Next.js server for SSR (Server-Side Rendering) and other pages
        location @nextjs {
            proxy_pass http://nextjs:3000;  # Forward request to the Next.js app
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Error pages
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }

        # Custom headers for security and caching
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
}
